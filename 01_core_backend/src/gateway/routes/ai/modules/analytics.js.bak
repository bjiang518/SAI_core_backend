/**
 * Analytics Routes Module
 * Handles AI-powered analytics and insights generation
 *
 * Extracted from ai-proxy.js lines 653-3391
 */

const AIServiceClient = require('../../../services/ai-client');

class AnalyticsRoutes {
  constructor(fastify) {
    this.fastify = fastify;
    this.aiClient = new AIServiceClient();
  }

  /**
   * Register all analytics routes
   */
  registerRoutes() {
    // AI Analytics for Parent Reports
    this.fastify.post('/api/ai/analytics/insights', {
      schema: {
        description: 'Generate AI-powered insights for parent reports',
        tags: ['AI', 'Analytics', 'Parent Reports'],
        body: {
          type: 'object',
          required: ['report_data'],
          properties: {
            report_data: {
              type: 'object',
              description: 'Comprehensive report data from aggregation service'
            }
          }
        }
      }
    }, this.generateAIInsights.bind(this));
  }

  /**
   * Generate AI insights from report data
   */
  async generateAIInsights(request, reply) {
    const startTime = Date.now();

    try {
      this.fastify.log.info('üß† === AI ANALYTICS INSIGHTS REQUEST ===');
      this.fastify.log.info(`üìä Report data keys: ${Object.keys(request.body.report_data)}`);

      // Proxy request to AI Engine analytics endpoint
      const result = await this.aiClient.proxyRequest(
        'POST',
        '/api/v1/analytics/insights',
        request.body,
        { 'Content-Type': 'application/json' }
      );

      if (result.success) {
        const duration = Date.now() - startTime;

        this.fastify.log.info('‚úÖ === AI ANALYTICS INSIGHTS SUCCESS ===');
        this.fastify.log.info(`‚è±Ô∏è Gateway processing time: ${duration}ms`);
        this.fastify.log.info(`üéØ Generated insights: ${Object.keys(result.data.insights || {})}`);

        return reply.send({
          ...result.data,
          _gateway: {
            processTime: duration,
            service: 'ai-engine',
            endpoint: '/api/v1/analytics/insights'
          }
        });
      } else {
        this.fastify.log.error('‚ùå AI Analytics insights generation failed:', result.error);
        return this.handleProxyError(reply, result.error);
      }
    } catch (error) {
      this.fastify.log.error('Error generating AI insights:', error);
      return reply.status(500).send({
        success: false,
        insights: null,
        processing_time_ms: Date.now() - startTime,
        error: 'Internal server error generating AI insights',
        code: 'AI_INSIGHTS_ERROR'
      });
    }
  }

  /**
   * Handle proxy error responses
   */
  handleProxyError(reply, error) {
    const statusCode = error.status || 500;

    if (error.type === 'CONNECTION_ERROR') {
      return reply.status(503).send({
        error: 'AI service temporarily unavailable',
        code: 'SERVICE_UNAVAILABLE',
        retry: true
      });
    }

    if (error.type === 'SERVICE_ERROR') {
      return reply.status(statusCode).send({
        error: error.message,
        code: error.data?.code || 'AI_SERVICE_ERROR',
        details: error.data
      });
    }

    return reply.status(statusCode).send({
      error: 'Unexpected error occurred',
      code: 'UNKNOWN_ERROR'
    });
  }
}

module.exports = AnalyticsRoutes;
